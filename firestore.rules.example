
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default: Deny all reads and writes by default.
    // Specific allow rules below will override this for their matched paths.
    match /{document=**} {
      allow read, write: if false;
    }

    // Rules for 'restaurantConfig' collection
    // This path matches individual documents directly under 'restaurantConfig',
    // such as /restaurantConfig/mainRestaurant or /restaurantConfig/USER_ID
    match /restaurantConfig/{configId} {
      // Allow public GET (read of a single document) for 'mainRestaurant' config.
      // This is for the public homepage or public booking page to fetch general restaurant info.
      allow get: if configId == "mainRestaurant";
      // Deny list, create, update, delete for 'mainRestaurant' by the public.
      allow list, create, update, delete: if false;

      // Allow an authenticated user to read and write their OWN top-level config document.
      // This document (e.g., /restaurantConfig/USER_ID) typically stores overall settings, schedule.
      // This rule does NOT cover subcollections within this document; those are handled by the rule below.
      allow read, write: if request.auth != null && request.auth.uid == configId;
    }

    // Rule for all user-specific data *within* their restaurantConfig directory (i.e., subcollections).
    // This covers subcollections like 'tables', 'emailTemplates', etc., under a specific user's config.
    // e.g., /restaurantConfig/{userId}/tables/{tableId}
    // e.g., /restaurantConfig/{userId}/emailTemplates/{templateId}
    match /restaurantConfig/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }


    // Bookings collection (Root collection)
    // IMPORTANT: This rule assumes each booking document has an 'ownerUID' field
    // storing the UID of the restaurant owner (the authenticated user who created it).
    // Your application code (e.g., bookingService.ts) MUST add this 'ownerUID' field
    // to new booking documents for these rules to work correctly.
    match /bookings/{bookingId} {
      // Allow a user to create a booking if they are authenticated and
      // the 'ownerUID' in the new booking data matches their own UID.
      allow create: if request.auth != null && request.resource.data.ownerUID == request.auth.uid;

      // Allow a user to read, update, or delete a booking if they are authenticated
      // and their UID matches the 'ownerUID' stored on the booking document.
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.ownerUID;

      // Note: If there's a need for guests (unauthenticated or differently authenticated users)
      // to view their own bookings, more complex rules and data structures would be required.
      // For now, these rules focus on owner-based management.
    }

    // Add rules for other root collections as your application grows.
  }
}
