rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    //  Stripe Customer Data
    //  Allows users to manage their own payment methods and subscriptions.
    // =====================================================================
    match /customers/{uid}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // =====================================================================
    //  Restaurant Configuration (Private)
    //  Each user can only read/write their own restaurant settings.
    // =====================================================================
    match /restaurantConfig/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // =====================================================================
    //  Restaurant Configuration (Public)
    //  Allows public read-only access to a specific document for the homepage.
    // =====================================================================
    match /restaurantConfig/mainRestaurant {
      allow get: if true;
      allow list, create, update, delete: if false; // Prevent public writes/listing
    }
    
    // =====================================================================
    //  Email Templates
    //  Allows users to read/write their own email templates.
    // =====================================================================
    match /restaurantConfig/{userId}/emailTemplates/{templateId} {
      allow read, write: if request.auth.uid == userId;
    }


    // =====================================================================
    //  Bookings
    // =====================================================================
    match /bookings/{bookingId} {
      // Allow creation if the user is authenticated and is the owner of the booking
      allow create: if request.auth != null && request.resource.data.ownerUID == request.auth.uid;
      // Allow read, update, delete if the user is the owner of the booking
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.ownerUID;
    }
    
    // =====================================================================
    //  Tables
    //  Users can read/write tables within their own restaurant config.
    // =====================================================================
    match /restaurantConfig/{userId}/tables/{tableId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // =====================================================================
    //  Forum Posts
    //  Users can create posts, and only read/update their own posts.
    // =====================================================================
    match /forumPosts/{postId} {
        allow create: if request.auth != null;
        allow read, update: if request.auth != null && resource.data.ownerUID == request.auth.uid;
        // Deletion can be restricted
        allow delete: if false; 
    }
  }
}
